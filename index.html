<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiLo Monad</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background-color: #30036D;
            color: white;
            margin: 0;
            padding: 0;
        }
        #hilo-container {
            position: relative;
            margin: 2em auto;
            width: min(400px, 90vw);
            height: min(400px, 90vw);
            z-index: 10;
        }
        #card-board {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #6A5ACD;
            background-size: cover;
            background-position: center;
            padding-bottom: 100px;
            overflow: hidden;
        }
        .card {
            position: absolute;
            width: 210px;
            height: 300px;
            background: none;
            color: #d00;
            font-size: 50px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 0px solid #000;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: opacity 0.4s ease, transform 0.4s ease;
            overflow: hidden;
        }
        .card img {
            object-fit: cover;
        }
        #current-card {
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transform-origin: left center;
            z-index: 1;
        }
        #next-card {
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transform-origin: right center;
            display: none;
            z-index: 1;
        }
        #discard-pile {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: row;
            gap: 10px;
            z-index: 5;
        }
        .discard-card {
            width: 50px;
            height: 75px;
            display: inline-block;
        }
        #probabilities {
            position: absolute;
            top: 30%;
            left: 50%;
            width: 5%;
            height: auto;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            color: white;
            line-height: 1.2;
            z-index: 20;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 8px;
            text-align: center;
        }
        #connect-wallet-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(400px, 80vw);
            height: 140px;
            background: #1e1a2a;
            border: 1px solid #836EF9;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            padding: 10px;
        }
        #total-points-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(400px, 80vw);
            height: 140px;
            background: #1e1a2a;
            border: 1px solid #836EF9;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 100;
            padding: 10px;
        }
        #game-over-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(400px, 80vw);
            height: 140px;
            background: #1e1a2a;
            border: 1px solid #836EF9;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 100;
            padding: 10px;
        }
        .points-message-content {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .points-message-content p {
            margin: 0;
            color: #C99CFF;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        .close-points-btn, .close-game-over-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #5B4FC0;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s;
        }
        .close-points-btn:hover, .close-game-over-btn:hover {
            background: #836EF9;
        }
        #segment-counts-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(450px, 80vw);
            height: 140px;
            background: #1e1a2a;
            border: 1px solid #836EF9;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 100;
            padding: 10px;
        }
        .segment-counts-content {
            position: relative;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }
        #segment-counts-list {
            margin: 0;
            padding: 0 10px;
            list-style: none;
            color: #C99CFF;
            font-size: 14px;
            font-weight: bold;
            overflow-y: auto;
            flex: 1;
        }
        #segment-counts-list::-webkit-scrollbar {
            width: 8px;
        }
        #segment-counts-list::-webkit-scrollbar-track {
            background: #30036D;
            border-radius: 4px;
        }
        #segment-counts-list::-webkit-scrollbar-thumb {
            background: #836EF9;
            border-radius: 4px;
        }
        #segment-counts-list::-webkit-scrollbar-thumb:hover {
            background: #5B4FC0;
        }
        #segment-counts-list li {
            margin-bottom: 5px;
        }
        .close-segment-counts-btn {
            position: absolute;
            top: 10px;
            right: 30px;
            background: #5B4FC0;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s;
        }
        .close-segment-counts-btn:hover {
            background: #836EF9;
        }
        #leaderboard-message {
            position: absolute;
            top: 47%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(450px, 80vw);
            height: 550px;
            background: #1e1a2a;
            border: 1px solid #836EF9;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 100;
            padding: 10px;
        }
        .leaderboard-content {
            position: relative;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }
        #leaderboard-list {
            margin: 0;
            padding: 0 10px;
            list-style: none;
            color: #C99CFF;
            font-size: 14px;
            font-weight: bold;
            overflow-y: auto;
            flex: 1;
        }
        #leaderboard-list::-webkit-scrollbar {
            width: 8px;
        }
        #leaderboard-list::-webkit-scrollbar-track {
            background: #30036D;
            border-radius: 4px;
        }
        #leaderboard-list::-webkit-scrollbar-thumb {
            background: #836EF9;
            border-radius: 4px;
        }
        #leaderboard-list::-webkit-scrollbar-thumb:hover {
            background: #5B4FC0;
        }
        #leaderboard-list li {
            margin-bottom: 5px;
        }
        .close-leaderboard-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #5B4FC0;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s;
        }
        .close-leaderboard-btn:hover {
            background: #836EF9;
        }
        #log-container {
            position: absolute !important;
            top: 202px;
            left: calc(50% - min(400px, 90vw) / 2 - 290px);
            width: 200px !important;
            height: 200px !important;
            overflow-y: auto !important;
            background: #1e1a2a !important;
            border: 1px solid #836EF9 !important;
            border-radius: 12px !important;
            padding: 15px !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 10px !important;
            z-index: 15 !important;
            cursor: grab;
            will-change: left, top;
        }
        #log-container::-webkit-scrollbar {
            width: 8px;
        }
        #log-container::-webkit-scrollbar-track {
            background: #30036D;
            border-radius: 4px;
        }
        #log-container::-webkit-scrollbar-thumb {
            background: #836EF9;
            border-radius: 4px;
        }
        #log-container::-webkit-scrollbar-thumb:hover {
            background: #5B4FC0;
        }
        #log-container h3.drag-handle {
            font-size: 12px;
            margin: 0 0 10px 0;
            color: white;
            user-select: none;
            padding: 5px;
        }
        #log-container h3.drag-handle:active {
            cursor: grabbing;
        }
        #log-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 10px;
            color: white;
            flex: 1;
        }
        #log-list li {
            margin-bottom: 8px;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        #total-points-btn, #segment-counts-btn, #leaderboard-btn {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: linear-gradient(to bottom, #836EF9, #5B4FC0);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        #total-points-btn:hover, #segment-counts-btn:hover, #leaderboard-btn:hover {
            background: linear-gradient(to bottom, #5B4FC0, #836EF9);
        }
        #play-btn, #higher-btn, #lower-btn, #stop-btn, #skip-btn {
            padding: 12px 16px;
            margin: 0 5px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        #play-btn {
            background: linear-gradient(to bottom, #4CAF50, #388E3C);
        }
        #play-btn:hover {
            background: linear-gradient(to bottom, #388E3C, #4CAF50);
        }
        #higher-btn, #lower-btn, #skip-btn {
            background: linear-gradient(to bottom, #836EF9, #5B4FC0);
        }
        #higher-btn:hover, #lower-btn:hover, #skip-btn:hover {
            background: linear-gradient(to bottom, #5B4FC0, #836EF9);
        }
        #stop-btn {
            background: linear-gradient(to bottom, #F44336, #D32F2F);
        }
        #stop-btn:hover {
            background: linear-gradient(to bottom, #D32F2F, #F44336);
        }
        #payout-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 120px;
            width: min(400px, 90vw);
            margin-left: auto;
            margin-right: auto;
            z-index: 10;
        }
        @media (max-width: 600px) {
            h1 {
                font-size: 24px;
            }
            p {
                font-size: 14px;
            }
            #log-container {
                position: relative !important;
                top: auto !important;
                left: auto !important;
                margin: 20px auto !important;
                width: min(200px, 64vw) !important;
                height: 150px !important;
            }
            #log-list {
                font-size: 9px;
            }
            #total-points-btn, #segment-counts-btn, #leaderboard-btn {
                font-size: 9px;
            }
            #play-btn, #higher-btn, #lower-btn, #stop-btn, #skip-btn {
                font-size: 10px;
                padding: 10px 12px;
            }
            #payout-container {
                margin-top: 120px;
            }
            .points-message-content p {
                font-size: 16px;
            }
            #segment-counts-list, #leaderboard-list {
                font-size: 12px;
            }
            #probabilities {
                top: calc(92% - 200px);
                left: 50%;
                width: 30%;
                height: auto;
                padding: 5px;
                font-size: 11px;
            }
            .card {
                transition: opacity 0.4s ease, transform 0.4s ease;
            }
            #current-card {
                transform-origin: left center;
            }
            #next-card {
                transform-origin: right center;
            }
        }
    </style>
</head>
<body>
    <h1>Monad Testnet</h1>
    <p>Click PLAY or press Space to play and STOP to save points.</p>
    <p>You can drag the dashboards.</p>
    <div id="hilo-container">
        <div id="card-board">
            <div id="discard-pile"></div>
            <div id="current-card" class="card"></div>
            <div id="next-card" class="card"></div>
        </div>
    </div>
    <div id="probabilities"></div>
    <div id="connect-wallet-message">
        <p>Connect your wallet</p>
    </div>
    <div id="total-points-message">
        <div class="points-message-content">
            <p>Total Points: 0 points</p>
            <button class="close-points-btn">X</button>
        </div>
    </div>
    <div id="game-over-message">
        <div class="points-message-content">
            <p id="game-over-text">Game Over! You lost all session points.</p>
            <button class="close-game-over-btn">X</button>
        </div>
    </div>
    <div id="segment-counts-message">
        <div class="segment-counts-content">
            <ul id="segment-counts-list"></ul>
            <button class="close-segment-counts-btn">X</button>
        </div>
    </div>
    <div id="leaderboard-message">
        <div class="leaderboard-content">
            <ul id="leaderboard-list"></ul>
            <button class="close-leaderboard-btn">X</button>
        </div>
    </div>
    <div id="payout-container">
        <button id="play-btn">PLAY</button>
        <button id="higher-btn">Higher</button>
        <button id="lower-btn">Lower</button>
        <button id="skip-btn">Skip Card</button>
        <button id="stop-btn">STOP</button>
    </div>
    <div id="log-container">
        <h3 class="drag-handle">Play History</h3>
        <button id="total-points-btn">View Total Points</button>
        <button id="segment-counts-btn">View Game History</button>
        <button id="leaderboard-btn">Leaderboard</button>
        <ul id="log-list"></ul>
    </div>
    <script>
        let logContainer = null;
        let size = 0;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let isDragging = false;
        let isWalletConnected = false;
        let isSpinning = false;
        let isRoundStarted = false;
        let sessionPoints = 0;
        let sessionMultiplier = 1.0;
        let greenStreak = 0;
        let gameHistory = [];
        let leaderboardData = [];
        let currentPlayerRank = { rank: 0, score: 0 };
        const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        const suits = ['coracao', 'espada', 'ouro', 'paus'];
        const rankMap = { 'A': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13 };
        const suitDisplayMap = {
            'coracao': 'coração',
            'espada': 'espada',
            'ouro': 'ouro',
            'paus': 'paus'
        };
        const rankDisplayMap = {
            'A': 'Ás',
            'J': 'Valete',
            'Q': 'Dama',
            'K': 'Rei'
        };
        const higherPayouts = {
            1: 1.1,
            2: 1.1,
            3: 1.2,
            4: 1.3,
            5: 1.4,
            6: 1.5,
            7: 1.8,
            8: 2,
            9: 3,
            10: 4,
            11: 5,
            12: 12,
            13: 0
        };
        const lowerPayouts = {
            1: 0,
            2: 12,
            3: 5,
            4: 4,
            5: 3,
            6: 2,
            7: 1.8,
            8: 1.5,
            9: 1.4,
            10: 1.3,
            11: 1.2,
            12: 1.1,
            13: 1.1
        };
        function getRandomCard() {
            const rankIndex = Math.floor(Math.random() * ranks.length);
            const suitIndex = Math.floor(Math.random() * suits.length);
            const rank = ranks[rankIndex];
            const suit = suits[suitIndex];
            const imageRank = rankMap[rank];
            const image = `/cards/${imageRank}_${suit}.png`;
            return { rank, suit, image };
        }
        function getRank(card) {
            return rankMap[card.rank] || 1;
        }
        function drawInitialCard() {
            const card = getRandomCard();
            console.log('Carta inicial: ' + card.image);
            const currentCardElem = document.getElementById('current-card');
            const rankDisplay = rankDisplayMap[card.rank] || card.rank;
            const suitDisplay = suitDisplayMap[card.suit];
            currentCardElem.innerHTML = `<img src="${card.image}" alt="${rankDisplay} de ${suitDisplay}" style="width:100%; height:100%; border-radius:10px; object-fit: cover;">`;
            currentCardElem.dataset.card = JSON.stringify(card);
        }
        document.addEventListener('DOMContentLoaded', () => {
            drawInitialCard();
            logContainer = document.getElementById('log-container');
            const dragHandle = logContainer.querySelector('.drag-handle');
            if (!logContainer || !dragHandle) {
                console.error('Log container or drag handle not found!');
                return;
            }
            console.log('Initializing drag for log-container...');
            if (window.innerWidth > 600) {
                logContainer.style.position = 'absolute';
                const hiloContainer = document.getElementById('hilo-container');
                const hiloRect = hiloContainer.getBoundingClientRect();
                currentX = parseFloat(logContainer.style.left) || (hiloRect.left - 290);
                currentY = parseFloat(logContainer.style.top) || 202;
                logContainer.style.left = `${currentX}px`;
                logContainer.style.top = `${currentY}px`;
            } else {
                logContainer.style.position = 'relative';
                currentX = 0;
                currentY = 0;
                logContainer.style.left = 'auto';
                logContainer.style.top = 'auto';
                logContainer.style.bottom = 'auto';
                logContainer.style.margin = '20px auto';
            }
            console.log('Log container initialized at x:', currentX, 'y:', currentY);
            logContainer.addEventListener('mousedown', (e) => {
                if (e.target.closest('button')) return;
                console.log('Drag started on log-container');
                e.preventDefault();
                e.stopPropagation();
                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;
                isDragging = true;
                logContainer.style.position = 'absolute';
                logContainer.style.margin = '0';
            });
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    e.preventDefault();
                    e.stopPropagation();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    logContainer.style.left = `${currentX}px`;
                    logContainer.style.top = `${currentY}px`;
                    logContainer.style.bottom = 'auto';
                    logContainer.style.margin = '0';
                }
            });
            document.addEventListener('mouseup', (e) => {
                if (isDragging) {
                    isDragging = false;
                    e.stopPropagation();
                }
            });
            logContainer.addEventListener('touchstart', (e) => {
                if (e.target.closest('button')) return;
                e.preventDefault();
                e.stopPropagation();
                const touch = e.touches[0];
                initialX = touch.clientX - currentX;
                initialY = touch.clientY - currentY;
                isDragging = true;
                logContainer.style.position = 'absolute';
                logContainer.style.margin = '0';
            });
            document.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    e.preventDefault();
                    e.stopPropagation();
                    const touch = e.touches[0];
                    currentX = touch.clientX - initialX;
                    currentY = touch.clientY - initialY;
                    logContainer.style.left = `${currentX}px`;
                    logContainer.style.top = `${currentY}px`;
                    logContainer.style.bottom = 'auto';
                    logContainer.style.margin = '0';
                }
            });
            document.addEventListener('touchend', (e) => {
                if (isDragging) {
                    isDragging = false;
                    e.stopPropagation();
                }
            });
            logContainer.addEventListener('dragstart', (e) => {
                e.preventDefault();
            });
            document.getElementById('card-board').addEventListener('touchstart', function (e) {
                if (!isWalletConnected) {
                    toggleConnectMessage(true);
                    e.preventDefault();
                    return;
                }
                if (!isSpinning && !isRoundStarted) {
                    startRound();
                    e.preventDefault();
                }
            });
            document.getElementById('play-btn').addEventListener('click', () => {
                if (window.sendGameAction) {
                    window.sendGameAction();
                } else {
                    console.log('Game action function not ready!');
                }
                if (!isWalletConnected) {
                    toggleConnectMessage(true);
                    return;
                }
                if (!isSpinning && !isRoundStarted) {
                    startRound();
                }
            });
            document.getElementById('stop-btn').addEventListener('click', () => {
                if (isRoundStarted) {
                    updateSessionPoints();
                    toggleTotalPointsMessage(true);
                    window.dispatchEvent(new CustomEvent('prizeAwarded', { detail: { prize: sessionPoints } }));
                    endGame(true);
                } else {
                    window.dispatchEvent(new CustomEvent('prizeAwarded', { detail: { prize: 0 } }));
                }
            });
            document.getElementById('skip-btn').addEventListener('click', () => {
                if (!isRoundStarted) {
                    drawInitialCard();
                }
            });
            window.addEventListener('walletConnected', () => {
                isWalletConnected = true;
                console.log('Wallet connected');
            });
            window.addEventListener('userLoggedOut', () => {
                isWalletConnected = false;
                console.log('User logged out');
            });
            window.addEventListener('leaderboardUpdated', (event) => {
                console.log('leaderboardUpdated event received:', event.detail);
                leaderboardData = event.detail.leaderboard || [];
                currentPlayerRank = event.detail.playerRank || { rank: 0, score: 0 };
                if (document.getElementById('leaderboard-message').style.display === 'block') {
                    toggleLeaderboardMessage(true, leaderboardData, currentPlayerRank);
                }
            });
            window.addEventListener('prizeConfirmed', (event) => {
                const prize = event.detail.prize;
                console.log(`Prize confirmed: ${prize}`);
                toggleTotalPointsMessage(true);
            });
        });
        try {
            console.log("Initializing HiLo...");
            size = Math.min(window.innerWidth * 0.9, 400);
            window.addEventListener('resize', () => {
                size = Math.min(window.innerWidth * 0.9, 400);
                if (logContainer) {
                    const hiloContainer = document.getElementById('hilo-container');
                    const hiloRect = hiloContainer.getBoundingClientRect();
                    if (window.innerWidth > 600) {
                        if (!isDragging) {
                            currentX = hiloRect.left - 290;
                            logContainer.style.left = `${currentX}px`;
                            logContainer.style.top = '202px';
                            logContainer.style.bottom = 'auto';
                            logContainer.style.margin = '0';
                            logContainer.style.position = 'absolute';
                        }
                    } else {
                        if (!isDragging) {
                            currentX = 0;
                            currentY = 0;
                            logContainer.style.left = 'auto';
                            logContainer.style.top = 'auto';
                            logContainer.style.bottom = 'auto';
                            logContainer.style.margin = '20px auto';
                            logContainer.style.position = 'relative';
                        }
                    }
                }
            });
            function updateSessionPoints() {
                sessionPoints = Math.max(0, Math.round(100 * (sessionMultiplier - 1)));
                const logList = document.getElementById('log-list');
                if (logList) {
                    const logItem = document.createElement('li');
                    logItem.textContent = `Points: ${sessionPoints} (x${sessionMultiplier.toFixed(2)})`;
                    logList.insertBefore(logItem, logList.firstChild);
                }
                if (document.getElementById('total-points-message').style.display === 'block') {
                    toggleTotalPointsMessage(true);
                }
            }
            function moveToDiscardPile(card) {
                const discardPile = document.getElementById('discard-pile');
                const discardCard = document.createElement('div');
                discardCard.className = 'discard-card';
                const rankDisplay = rankDisplayMap[card.rank] || card.rank;
                const suitDisplay = suitDisplayMap[card.suit];
                discardCard.innerHTML = `<img src="${card.image}" alt="${rankDisplay} de ${suitDisplay}" style="width:50px; height:75px; object-fit: cover;">`;
                discardPile.appendChild(discardCard);
                while (discardPile.children.length > 5) {
                    discardPile.removeChild(discardPile.firstChild);
                }
            }
            function startRound() {
                if (isSpinning || isRoundStarted || !isWalletConnected) {
                    toggleConnectMessage(true);
                    return;
                }
                isRoundStarted = true;
                sessionMultiplier = 1.0;
                sessionPoints = 0;
                greenStreak = 0;
                gameHistory = [];
                document.getElementById('log-list').innerHTML = '';
                document.getElementById('next-card').style.display = 'none';
                document.getElementById('discard-pile').innerHTML = '';
                const currentCardElem = document.getElementById('current-card');
                const card = JSON.parse(currentCardElem.dataset.card);
                const rank = getRank(card);
                updateProbabilities(rank);
                document.getElementById('probabilities').style.display = 'block';
                document.getElementById('skip-btn').style.display = 'none';
                const higherBtn = document.getElementById('higher-btn');
                const lowerBtn = document.getElementById('lower-btn');
                const stopBtn = document.getElementById('stop-btn');
                const playBtn = document.getElementById('play-btn');
                playBtn.disabled = true;
                higherBtn.disabled = false;
                lowerBtn.disabled = false;
                stopBtn.disabled = false;
            }
            function updateProbabilities(rank) {
                const probHi = ((13 - rank) / 13 * 100).toFixed(0);
                const probLo = ((rank - 1) / 13 * 100).toFixed(0);
                const probTie = (1 / 13 * 100).toFixed(0);
                let html = '';
                if (rank > 1) html += `Lower: ${probLo}%<br>`;
                if (rank < 13) html += `Higher: ${probHi}%<br>`;
                html += `Same: ${probTie}%`;
                document.getElementById('probabilities').innerHTML = html;
            }
            function endGame(savePoints) {
                if (savePoints) {
                    updateSessionPoints();
                    console.log(`Game ended. Points to save: ${sessionPoints}`);
                } else {
                    console.log('❌ Game Over');
                    toggleGameOverMessage(true);
                    sessionPoints = 0;
                    updateSessionPoints();
                }
                isRoundStarted = false;
                isSpinning = false;
                document.getElementById('current-card').textContent = '';
                document.getElementById('next-card').style.display = 'none';
                document.getElementById('probabilities').innerHTML = '';
                document.getElementById('probabilities').style.display = 'none';
                document.getElementById('discard-pile').innerHTML = '';
                const higherBtn = document.getElementById('higher-btn');
                const lowerBtn = document.getElementById('lower-btn');
                const stopBtn = document.getElementById('stop-btn');
                const playBtn = document.getElementById('play-btn');
                const skipBtn = document.getElementById('skip-btn');
                playBtn.disabled = false;
                higherBtn.disabled = true;
                lowerBtn.disabled = true;
                stopBtn.disabled = true;
                skipBtn.style.display = 'block';
                drawInitialCard();
                if (document.getElementById('total-points-message').style.display === 'block') {
                    toggleTotalPointsMessage(true);
                }
            }
            function toggleGameOverMessage(show) {
                const messageDiv = document.getElementById('game-over-message');
                const textP = document.getElementById('game-over-text');
                textP.textContent = 'Game Over! You lost all session points.';
                messageDiv.style.display = show ? 'block' : 'none';
            }
            document.querySelector('.close-game-over-btn').addEventListener('click', () => {
                toggleGameOverMessage(false);
            });
            function makeGuess(guess) {
                if (window.sendGameAction) {
                    window.sendGameAction();
                } else {
                    console.log('Game action function not ready!');
                }
                if (!isRoundStarted || isSpinning) return;
                isSpinning = true;
                const currentCardElem = document.getElementById('current-card');
                const currentCard = JSON.parse(currentCardElem.dataset.card);
                const rank = getRank(currentCard);
                const payout = (guess === 'higher') ? higherPayouts[rank] : lowerPayouts[rank];
                let nextCard = getRandomCard();
                let nextRank = getRank(nextCard);
                let result = '';
                let pointsAdded = 0;
                const nextCardElem = document.getElementById('next-card');
                const nextRankDisplay = rankDisplayMap[nextCard.rank] || nextCard.rank;
                const nextSuitDisplay = suitDisplayMap[nextCard.suit];
                nextCardElem.innerHTML = `<img src="${nextCard.image}" alt="${nextRankDisplay} de ${nextSuitDisplay}" style="width:100%; height:100%; border-radius:10px; object-fit: cover;">`;
                nextCardElem.dataset.card = JSON.stringify(nextCard);
                nextCardElem.style.display = 'flex';
                nextCardElem.style.opacity = '0';
                nextCardElem.style.transform = 'translate(-50%, -50%) rotateY(90deg)';
                setTimeout(() => {
                    nextCardElem.style.opacity = '1';
                    nextCardElem.style.transform = 'translate(-50%, -50%) rotateY(0deg)';
                }, 10);
                if (nextRank === rank) {
                    // Special case: Loss only if Ace with "higher" or King with "lower" and same rank
                    if ((rank === 1 && guess === 'higher') || (rank === 13 && guess === 'lower')) {
                        result = 'RED';
                        setTimeout(() => {
                            endGame(false);
                        }, 400);
                    } else {
                        // If same rank but not Ace/higher or King/lower, draw a new card with different suit
                        while (nextCard.suit === currentCard.suit) {
                            nextCard.suit = suits[Math.floor(Math.random() * suits.length)];
                        }
                        nextCard.image = `cards/${rankMap[nextCard.rank]}_${nextCard.suit}.png`;
                        const updatedNextSuitDisplay = suitDisplayMap[nextCard.suit];
                        nextCardElem.innerHTML = `<img src="${nextCard.image}" alt="${nextRankDisplay} de ${updatedNextSuitDisplay}" style="width:100%; height:100%; border-radius:10px; object-fit: cover;">`;
                        nextCardElem.dataset.card = JSON.stringify(nextCard);
                        setTimeout(() => {
                            currentCardElem.innerHTML = nextCardElem.innerHTML;
                            currentCardElem.dataset.card = nextCardElem.dataset.card;
                            nextCardElem.style.display = 'none';
                            isSpinning = false;
                        }, 800);
                        console.log('Same card - void, continuing with new suit...');
                        result = 'SAME';
                    }
                } else {
                    if ((guess === 'higher' && nextRank > rank) || (guess === 'lower' && nextRank < rank)) {
                        moveToDiscardPile(currentCard);
                        sessionMultiplier *= payout;
                        pointsAdded = Math.round(10 * (payout - 1));
                        currentCardElem.style.opacity = '0';
                        currentCardElem.style.transform = 'translate(-50%, -50%) rotateY(-90deg)';
                        setTimeout(() => {
                            currentCardElem.innerHTML = nextCardElem.innerHTML;
                            currentCardElem.dataset.card = nextCardElem.dataset.card;
                            currentCardElem.style.opacity = '1';
                            currentCardElem.style.transform = 'translate(-50%, -50%) rotateY(0deg)';
                            nextCardElem.style.display = 'none';
                            updateSessionPoints();
                            greenStreak++;
                            updateProbabilities(nextRank);
                            const higherBtn = document.getElementById('higher-btn');
                            const lowerBtn = document.getElementById('lower-btn');
                            higherBtn.disabled = false;
                            lowerBtn.disabled = false;
                            isSpinning = false;
                        }, 400);
                        result = 'GREEN';
                    } else {
                        result = 'RED';
                        setTimeout(() => {
                            endGame(false);
                        }, 400);
                    }
                }
                const currentRankDisplay = rankDisplayMap[currentCard.rank] || currentCard.rank;
                const currentSuitDisplay = suitDisplayMap[currentCard.suit];
                gameHistory.push({
                    card: `${currentRankDisplay} de ${currentSuitDisplay}`,
                    guess: guess.toUpperCase(),
                    result: result,
                    points: result === 'GREEN' ? pointsAdded : 0
                });
            }
            function toggleConnectMessage(show) {
                const messageDiv = document.getElementById('connect-wallet-message');
                const messageP = document.getElementById('connect-wallet-message').querySelector('p');
                let message = '';
                if (!isWalletConnected) {
                    message = 'Connect your wallet';
                }
                messageP.textContent = message;
                messageDiv.style.display = show && message ? 'flex' : 'none';
                if (show && message) {
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 7000);
                }
            }
            function toggleTotalPointsMessage(show) {
                const messageDiv = document.getElementById('total-points-message');
                const messageP = document.getElementById('total-points-message').querySelector('p');
                if (show) {
                    const formattedPoints = Number.isInteger(sessionPoints) ? sessionPoints.toString() : sessionPoints.toFixed(1);
                    messageP.textContent = `Total Points: ${formattedPoints} points`;
                }
                messageDiv.style.display = show ? 'block' : 'none';
            }
            function toggleSegmentCountsMessage(show) {
                const messageDiv = document.getElementById('segment-counts-message');
                const list = document.getElementById('segment-counts-list');
                if (show) {
                    list.innerHTML = '';
                    if (gameHistory.length > 0) {
                        let tempMultiplier = 1.0;
                        gameHistory.forEach((entry, index) => {
                            const li = document.createElement('li');
                            let points = 0;
                            if (entry.result === 'GREEN') {
                                const rank = getRank({rank: entry.card.split(' ')[0]});
                                const payout = (entry.guess === 'HIGHER') ? higherPayouts[rank] : lowerPayouts[rank];
                                tempMultiplier *= payout;
                                points = Math.max(0, Math.round(100 * (tempMultiplier - 1)));
                            }
                            li.textContent = `Card: ${entry.card}, Choice: ${entry.guess}, Result: ${entry.result}, Points: ${points}`;
                            list.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.textContent = 'No games played yet.';
                        list.appendChild(li);
                    }
                }
                messageDiv.style.display = show ? 'block' : 'none';
            }
            function toggleLeaderboardMessage(show, leaderboardData, playerRank) {
                const messageDiv = document.getElementById('leaderboard-message');
                const list = document.getElementById('leaderboard-list');
                if (show) {
                    list.innerHTML = '';
                    if (!leaderboardData || leaderboardData.length === 0) {
                        const li = document.createElement('li');
                        li.textContent = 'Loading leaderboard...';
                        list.appendChild(li);
                    } else {
                        leaderboardData.forEach((entry, index) => {
                            const li = document.createElement('li');
                            const formattedScore = Number.isInteger(entry.score) ? entry.score.toString() : entry.score.toFixed(1);
                            li.textContent = `${index + 1}. ${entry.username || 'Unknown'}: ${formattedScore} points`;
                            list.appendChild(li);
                        });
                    }
                    if (isWalletConnected && playerRank && typeof playerRank.score === 'number' && playerRank.score >= 0) {
                        const playerLi = document.createElement('li');
                        const formattedPlayerScore = Number.isInteger(playerRank.score) ? playerRank.score.toString() : playerRank.score.toFixed(1);
                        playerLi.textContent = `Your Rank: ${playerRank.rank || 'Not ranked'}, Your Score: ${formattedPlayerScore} points`;
                        playerLi.style.marginTop = '10px';
                        playerLi.style.borderTop = '1px solid #836EF9';
                        playerLi.id = 'player-rank';
                        if (!list.querySelector('#player-rank')) {
                            list.appendChild(playerLi);
                        }
                    }
                }
                messageDiv.style.display = show ? 'block' : 'none';
            }
            function closeAllPanels() {
                toggleTotalPointsMessage(false);
                toggleSegmentCountsMessage(false);
                toggleLeaderboardMessage(false);
                toggleGameOverMessage(false);
            }
            document.getElementById('total-points-btn').addEventListener('click', () => {
                closeAllPanels();
                toggleTotalPointsMessage(true);
            });
            document.querySelector('.close-points-btn').addEventListener('click', () => {
                toggleTotalPointsMessage(false);
            });
            document.getElementById('segment-counts-btn').addEventListener('click', () => {
                closeAllPanels();
                toggleSegmentCountsMessage(true);
            });
            document.querySelector('.close-segment-counts-btn').addEventListener('click', () => {
                toggleSegmentCountsMessage(false);
            });
            document.getElementById('leaderboard-btn').addEventListener('click', () => {
                console.log('Leaderboard button clicked');
                closeAllPanels();
                toggleLeaderboardMessage(true, leaderboardData, currentPlayerRank);
            });
            document.querySelector('.close-leaderboard-btn').addEventListener('click', () => {
                toggleLeaderboardMessage(false);
            });
            document.getElementById('higher-btn').addEventListener('click', () => makeGuess('higher'));
            document.getElementById('lower-btn').addEventListener('click', () => makeGuess('lower'));
            document.addEventListener('keydown', (e) => {
                if (e.key === ' ') {
                    if (!isSpinning && !isRoundStarted) {
                        startRound();
                    }
                } else if (e.key.toLowerCase() === 'h') {
                    makeGuess('higher');
                } else if (e.key.toLowerCase() === 'l') {
                    makeGuess('lower');
                }
            });
            console.log("HiLo initialized successfully!");
        } catch (error) {
            console.error("Error initializing HiLo:", error);
        }
    </script>
    <script type="module" src="/app.jsx"></script>
</body>
</html>